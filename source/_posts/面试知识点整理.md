---
title: é¢è¯•çŸ¥è¯†ç‚¹æ•´ç†
date: 2018-04-17 14:33:30
tags:
---

# Part 0

çœ‹ä»¥ä¸‹ä¹ é¢˜å‰å¯ä»¥å…ˆçœ‹çœ‹ä¸‹é¢çš„åˆ«äººæ•´ç†å¥½çš„é¢è¯•é¢˜ï¼š

[iOSInterviewQuestions](https://github.com/ChenYilong/iOSInterviewQuestions/blob/master/01%E3%80%8A%E6%8B%9B%E8%81%98%E4%B8%80%E4%B8%AA%E9%9D%A0%E8%B0%B1%E7%9A%84iOS%E3%80%8B%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%82%E8%80%83%E7%AD%94%E6%A1%88/%E3%80%8A%E6%8B%9B%E8%81%98%E4%B8%80%E4%B8%AA%E9%9D%A0%E8%B0%B1%E7%9A%84iOS%E3%80%8B%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%82%E8%80%83%E7%AD%94%E6%A1%88%EF%BC%88%E4%B8%8B%EF%BC%89.md)**ã€å¼ºçƒˆæ¨èçœ‹ã€‘**

****


# Part 1

ä¹ é¢˜æ¥è‡ªï¼š[iOS-InterviewQuestion-collection](https://github.com/liberalisman/iOS-InterviewQuestion-collection)

## 0x01 å†…å­˜ç®¡ç†
**``@autoreleasrPool`` çš„é‡Šæ”¾æ—¶æœºï¼Ÿ**

åœ¨æ²¡æœ‰æ‰‹åŠ Autorelease Poolçš„æƒ…å†µä¸‹ï¼ŒAutoreleaseå¯¹è±¡æ˜¯åœ¨å½“å‰çš„``runloop``è¿­ä»£ç»“æŸæ—¶é‡Šæ”¾çš„ï¼Œè€Œå®ƒèƒ½å¤Ÿé‡Šæ”¾çš„åŸå› æ˜¯**ç³»ç»Ÿåœ¨æ¯ä¸ªrunloopè¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± Pushå’ŒPop**

å‚è€ƒï¼š

[å¹•èƒŒåçš„Autorelease](http://blog.sunnyxx.com/2014/10/15/behind-autorelease/)

[Autoreleaseå¯¹è±¡çš„é‡Šæ”¾æ—¶æœº](https://www.jianshu.com/p/cfbe4c010dd0)

[arc å†…å­˜ç®¡ç†è¦ç‚¹](http://www.samirchen.com/ios-arc/)

*****************

**è‡ªåŠ¨å¼•ç”¨è®¡``ï¼ˆARCï¼‰``æ•°åº”è¯¥éµå¾ªçš„åŸåˆ™?**

ä¸èƒ½ä½¿ç”¨ retain/release/retainCount/autorelease

ä¸èƒ½ä½¿ç”¨ NSAllocateObject/NSDeallocateObject

é¡»éµå®ˆå†…å­˜ç®¡ç†çš„æ–¹æ³•å‘½åè§„åˆ™

ä¸è¦æ˜¾ç¤ºè°ƒç”¨dealloc

ä½¿ç”¨ @autorelease å—ä»£æ›¿NSAutoreleasePool

ä¸èƒ½ä½¿ç”¨åŒºåŸŸï¼ˆNSZoneï¼‰

å¯¹è±¡å‹å˜é‡ä¸èƒ½ä½œä¸ºCè¯­è¨€ç»“å›ºä½“çš„æˆå‘˜

æ˜¾ç¤ºè½¬æ¢â€œidâ€å’Œ"void *"

å‚è€ƒï¼š

[OCå†…å­˜ç®¡ç†æ•™ç¨‹ä¹‹ARC(äºŒ)â€”â€”è‡ªåŠ¨å¼•ç”¨è®¡æ•°è§„åˆ™](https://blog.csdn.net/sodawaterer/article/details/72625824)

************

**è®¿é—®``__weak``ä¿®é¥°çš„å˜é‡ï¼Œæ˜¯å¦å·²ç»è¢«æ³¨å†Œåœ¨äº† ``@autoreleasePool`` ä¸­ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ**

åœ¨è®¿é—® ``__weak`` ä¿®é¥°çš„å˜é‡æ—¶ï¼Œå®é™…ä¸Šå¿…å®šä¼šè®¿é—®æ³¨å†Œåˆ° ``Autorelease Pool`` çš„å¯¹è±¡ã€‚å¦‚ä¸‹æ¥å¹´ä¸¤æ®µä»£ç æ˜¯ç›¸åŒçš„æ•ˆæœï¼š

```
id __weak obj1 = obj0;
NSLog(@"class=%@", [obj1 class]);
// ç­‰åŒäºï¼š
id __weak obj1 = obj0;
id __autoreleasing tmp = obj1;
NSLog(@"class=%@", [tmp class]);

```
ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿå› ä¸º ``__weak`` ä¿®é¥°ç¬¦åªæŒæœ‰å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè€Œåœ¨è®¿é—®å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥å¯¹è±¡æœ‰å¯èƒ½è¢«åºŸå¼ƒï¼Œå¦‚æœæŠŠè¢«è®¿é—®çš„å¯¹è±¡æ³¨å†Œåˆ° Autorelease Pool ä¸­ï¼Œå°±èƒ½ä¿è¯ Autorelease Pool è¢«é”€æ¯å‰å¯¹è±¡æ˜¯å­˜åœ¨çš„ã€‚

å‚è€ƒï¼š

[arc å†…å­˜ç®¡ç†è¦ç‚¹](http://www.samirchen.com/ios-arc/)

***********

**ARC çš„ retainCount æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ**

the reference counts for most objects are stored in **hash tables**. Have a look at the ``_objc_rootRetain`` function in ``runtime/objc-arr.mm``

å‚è€ƒï¼š

[Where is the retain count stored for NSObjects in Objective C
](https://stackoverflow.com/questions/10109645/where-is-the-retain-count-stored-for-nsobjects-in-objective-c)

*********

**ç®€è¦è¯´ä¸€ä¸‹ @autoreleasePool çš„æ•°æ®ç»“æ„**

```
AutoreleasePoolPage {
    magic_t const magic;
    id *next;
    pthread_t const thread;
    AutoreleasePoolPage * const parent;
    AutoreleasePoolPage *child;
    uint32_t const depth;
    uint32_t hiwat;
}

```

magicç”¨æ¥æ ¡éªŒAutoreleasePoolPageç»“æ„æ˜¯å¦å®Œæ•´ï¼›

nextæŒ‡å‘ç¬¬ä¸€ä¸ªå¯ç”¨çš„åœ°å€ï¼›

threadæŒ‡å‘å½“å‰çš„çº¿ç¨‹ï¼›

parentæŒ‡å‘çˆ¶ç±»

childæŒ‡å‘å­ç±»

å‚è€ƒï¼š

[æ·±å…¥ç†è§£@autoreleasepool](https://www.jianshu.com/p/66282c943c04)

*********

**``__weak`` å’Œ ``_Unsafe_Unretain`` çš„åŒºåˆ«**

weakä¸unsafe_unretainedçš„åŒºåˆ«åœ¨äºï¼Œ``weak``ä¼šå°†è¢«é‡Šæ”¾æŒ‡é’ˆèµ‹å€¼ä¸ºnilï¼Œè€Œ``unsafe_unretained``åˆ™ä¼šæˆä¸ºé‡æŒ‡é’ˆã€‚

***********

**ä¸ºä»€ä¹ˆå·²ç»æœ‰äº† ARC ,ä½†è¿˜æ˜¯éœ€è¦ @AutoreleasePool çš„å­˜åœ¨ï¼Ÿ**

ARC å¹¶ä¸æ˜¯èˆå¼ƒäº† ``@autoreleasepool``ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå¸®ä½ æ’å…¥å¿…è¦çš„ ``retain``/``release``/``autorelease`` çš„ä»£ç è°ƒç”¨ã€‚

æ‰€ä»¥ï¼Œè·Ÿä½ æƒ³è±¡çš„ä¸ä¸€æ ·ï¼ŒARC ä¹‹ä¸‹ä¾ç„¶æ˜¯å»¶æ—¶é‡Šæ”¾çš„ï¼Œä¾ç„¶æ˜¯ä¾èµ–äº ``NSAutoreleasePool``ï¼Œè·Ÿé ARC æ¨¡å¼ä¸‹æ‰‹åŠ¨è°ƒç”¨é‚£äº›å‡½æ•°æœ¬è´¨ä¸Šæ¯«æ— å·®åˆ«ï¼Œåªæ˜¯ç¼–è¯‘å™¨æ¥åšä¼šä¿è¯å¼•ç”¨è®¡æ•°çš„æ­£ç¡®æ€§ã€‚

**************

**``__weak`` å±æ€§ä¿®é¥°çš„å˜é‡ï¼Œå¦‚ä½•å®ç°åœ¨å˜é‡æ²¡æœ‰å¼ºå¼•ç”¨åè‡ªåŠ¨ç½®ä¸º nil**

runtime å¯¹æ³¨å†Œçš„ç±»ï¼Œ ä¼šè¿›è¡Œå¸ƒå±€ï¼Œå¯¹äº weak å¯¹è±¡ä¼šæ”¾å…¥ä¸€ä¸ª hash è¡¨ä¸­ã€‚ ç”¨ weak æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€ä½œä¸º keyï¼Œå½“æ­¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0çš„æ—¶å€™ä¼š deallocï¼Œå‡å¦‚ weak æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€æ˜¯aï¼Œé‚£ä¹ˆå°±ä¼šä»¥aä¸ºé”®ï¼Œ åœ¨è¿™ä¸ª weak è¡¨ä¸­æœç´¢ï¼Œæ‰¾åˆ°æ‰€æœ‰ä»¥aä¸ºé”®çš„ weak å¯¹è±¡ï¼Œä»è€Œè®¾ç½®ä¸º nilã€‚

************

**è¯´ä¸€ä¸‹å¯¹ retain,copy,assign,weak,_Unsafe_Unretain å…³é”®å­—çš„ç†è§£**

``assign``è¡¨æ˜ setter ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„èµ‹å€¼æ“ä½œï¼Œé€šå¸¸ç”¨äºåŸºæœ¬çš„æ•°å€¼ç±»å‹ï¼Œä¾‹å¦‚CGFloatå’ŒNSIntegerã€‚

``weak``è¡¨æ˜å±æ€§å®šä¹‰äº†ä¸€ä¸ªéæ‹¥æœ‰è€…å…³ç³»ã€‚å½“ç»™å±æ€§è®¾å®šä¸€ä¸ªæ–°å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼ä¸ä¼šè¿›è¡Œ retainï¼Œæ—§å€¼ä¹Ÿä¸ä¼šè¿›è¡Œ releaseï¼Œ è€Œæ˜¯è¿›è¡Œç±»ä¼¼ assign çš„æ“ä½œã€‚ä¸è¿‡å½“å±æ€§æŒ‡å‘çš„å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œè¯¥å±æ€§ä¼šè¢«ç½®ä¸ºnilã€‚

``strong``è¡¨æ˜å±æ€§å®šä¹‰ä¸€ä¸ªæ‹¥æœ‰è€…å…³ç³»ã€‚å½“ç»™å±æ€§è®¾å®šä¸€ä¸ªæ–°å€¼çš„æ—¶å€™ï¼Œé¦–å…ˆè¿™ä¸ªå€¼è¿›è¡Œ retain ï¼Œæ—§å€¼è¿›è¡Œ release ï¼Œç„¶åè¿›è¡Œèµ‹å€¼æ“ä½œã€‚

``copy``ç±»ä¼¼äº strongï¼Œä¸è¿‡åœ¨èµ‹å€¼æ—¶è¿›è¡Œ copy æ“ä½œè€Œä¸æ˜¯ retain æ“ä½œã€‚é€šå¸¸åœ¨éœ€è¦ä¿ç•™æŸä¸ªä¸å¯å˜å¯¹è±¡ï¼ˆNSStringæœ€å¸¸è§ï¼‰ï¼Œå¹¶ä¸”é˜²æ­¢å®ƒè¢«æ„å¤–æ”¹å˜æ—¶ä½¿ç”¨ã€‚

``unsafe_unretained``çš„è¯­ä¹‰å’Œ assign ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯ç”¨äºå¯¹è±¡ç±»å‹çš„ï¼Œè¡¨ç¤ºä¸€ä¸ªéæ‹¥æœ‰(unretained)çš„ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šåœ¨å¯¹è±¡è¢«é”€æ¯æ—¶ç½®ä¸ºnilçš„(unsafe)å…³ç³»ã€‚

å‚è€ƒï¼š

[Objective-C å†…å­˜ç®¡ç†â€”â€”ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡](https://segmentfault.com/a/1190000004943276)

[NSStringå±æ€§ä»€ä¹ˆæ—¶å€™ç”¨copyï¼Œä»€ä¹ˆæ—¶å€™ç”¨strong?](http://melodyofnight.github.io/2015/12/11/NSString%E5%B1%9E%E6%80%A7%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8copy%EF%BC%8C%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8strong/#more)

************

**ARC åœ¨ç¼–è¯‘æ—¶åšäº†å“ªäº›å·¥ä½œ**

æ ¹æ®ä»£ç æ‰§è¡Œçš„ä¸Šä¸‹æ–‡è¯­å¢ƒï¼Œåœ¨é€‚å½“çš„ä½ç½®æ’å…¥ ``retain``ï¼Œ``release``

*******

**ARC åœ¨è¿è¡Œæ—¶åšäº†å“ªäº›å·¥ä½œ**

å¾…æŸ¥~

****

**å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå¯¹å¯¹è±¡ autorelease ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ**

å‚è€ƒ [arc å†…å­˜ç®¡ç†è¦ç‚¹](http://www.samirchen.com/ios-arc/) è¿™ç¯‡ã€‚

*****

**è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ æ‚¬å‚æŒ‡é’ˆï¼Ÿä»€ä¹ˆæ˜¯ é‡æŒ‡é’ˆ?**

æ‚¬å‚æŒ‡é’ˆï¼ˆdangling pointerï¼‰ä¸€èˆ¬æ˜¯è¯´æŒ‡å‘å·²ç»è¢«é‡Šæ”¾çš„è‡ªç”±åŒºå†…å­˜ï¼ˆfree storeï¼‰çš„æŒ‡é’ˆï¼Œé‡æŒ‡é’ˆï¼ˆwild pointerï¼‰åˆ™ä¸€èˆ¬æ˜¯æœªç»åˆå§‹åŒ–çš„æŒ‡é’ˆã€‚å‰è€…æ›¾ç»æœ‰æ•ˆè¿‡ï¼Œåè€…ä»æœªæœ‰æ•ˆè¿‡ã€‚

å‚è€ƒï¼š

[æ‚¬å‚æŒ‡é’ˆï¼ˆDangling pointerï¼‰å’Œé‡æŒ‡é’ˆï¼ˆWild pointerï¼‰](http://www.cnblogs.com/submarine/archive/2013/03/02/2940169.html)

******

**å†…å­˜ç®¡ç†é»˜è®¤çš„å…³é”®å­—æ˜¯ä»€ä¹ˆï¼Ÿ**

strong

******

**å†…å­˜ä¸­çš„5å¤§åŒºåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

å†…å­˜5å¤§åŒº:å †,æ ˆ,æ–¹æ³•åŒº,å…¨å±€åŒº,å¸¸é‡åŒº
æ ˆ:ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜,ä¼šè‡ªåŠ¨æ¸…ç†æ ˆä¸­çš„å†…å­˜
å †: éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜
é™æ€åŒº:åˆç§°å…¨å±€åŒº
å¸¸é‡åŒº: å‚¨å­˜å¸¸é‡çš„åœ°æ–¹
æ–¹æ³•åŒº: å­˜æ”¾å‡½æ•°ä½“çš„äºŒè¿›åˆ¶ä»£ç 

*********

**æ˜¯å¦äº†è§£ æ·±æ‹·è´ å’Œ æµ…æ‹·è´ çš„æ¦‚å¿µï¼Œé›†åˆç±»æ·±æ‹·è´å¦‚ä½•å®ç°ï¼Ÿ**

``æ·±æ‹·è´``æ˜¯å†…å­˜æ‹·è´ï¼ŒæŒ‡å‘çš„æ˜¯ä¸åŒçš„å†…å­˜
``æµ…æ‹·è´``æ˜¯æŒ‡é’ˆæ‹·è´ï¼ŒæŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜

é›†åˆç±»æ·±æ‹·è´æ˜¯é€šè¿‡å½’æ¡£ã€è§£æ¡£å®ç°ã€‚

******

**BAD_ACCESS åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å‡ºç°?**

- è®¿é—®äº†é‡æŒ‡é’ˆï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„å¯¹è±¡æ‰§è¡Œäº†releaseã€è®¿é—®å·²ç»é‡Šæ”¾å¯¹è±¡çš„æˆå‘˜å˜é‡æˆ–è€…å‘æ¶ˆæ¯ã€‚
- æ­»å¾ªç¯

********

## 0x02 Runtime

**ç±»å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Ÿ**

Objective-Cç±»æ˜¯ç”±``Class``ç±»å‹æ¥è¡¨ç¤ºçš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘``objc_class``ç»“æ„ä½“çš„æŒ‡é’ˆã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```
typedef struct objc_class *Class;

```

æŸ¥çœ‹``objc/runtime.h``ä¸­``objc_class``ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š

```
struct objc_class {
    Class isa  OBJC_ISA_AVAILABILITY;
#if !__OBJC2__
    Class super_class                   	OBJC2_UNAVAILABLE;	// çˆ¶ç±»
    const char *name                      	OBJC2_UNAVAILABLE;	// ç±»å
    long version                          	OBJC2_UNAVAILABLE;	// ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0
    long info                            	OBJC2_UNAVAILABLE;	// ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†
    long instance_size                   	OBJC2_UNAVAILABLE;	// è¯¥ç±»çš„å®ä¾‹å˜é‡å¤§å°
    struct objc_ivar_list *ivars         	OBJC2_UNAVAILABLE;	// è¯¥ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨
    struct objc_method_list **methodLists 	OBJC2_UNAVAILABLE;	// æ–¹æ³•å®šä¹‰çš„é“¾è¡¨
    struct objc_cache *cache              	OBJC2_UNAVAILABLE;	// æ–¹æ³•ç¼“å­˜
    struct objc_protocol_list *protocols 	OBJC2_UNAVAILABLE;	// åè®®é“¾è¡¨
#endif
} OBJC2_UNAVAILABLE;

```
åœ¨è¿™ä¸ªå®šä¹‰ä¸­ï¼Œä¸‹é¢å‡ ä¸ªå­—æ®µæ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„

1. ``isa``ï¼šéœ€è¦æ³¨æ„çš„æ˜¯åœ¨Objective-Cä¸­ï¼Œæ‰€æœ‰çš„ç±»è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„``Class``é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ª``isa``æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘``metaClass``(å…ƒç±»)ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢ä»‹ç»å®ƒã€‚
2. ``super_class``ï¼šæŒ‡å‘è¯¥ç±»çš„çˆ¶ç±»ï¼Œå¦‚æœè¯¥ç±»å·²ç»æ˜¯æœ€é¡¶å±‚çš„æ ¹ç±»(å¦‚NSObjectæˆ–NSProxy)ï¼Œåˆ™``super_class``ä¸ºNULLã€‚
3. ``cache``ï¼šç”¨äºç¼“å­˜æœ€è¿‘ä½¿ç”¨çš„æ–¹æ³•ã€‚ä¸€ä¸ªæ¥æ”¶è€…å¯¹è±¡æ¥æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šæ ¹æ®isaæŒ‡é’ˆå»æŸ¥æ‰¾èƒ½å¤Ÿå“åº”è¿™ä¸ªæ¶ˆæ¯çš„å¯¹è±¡ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡åªæœ‰ä¸€éƒ¨åˆ†æ–¹æ³•æ˜¯å¸¸ç”¨çš„ï¼Œå¾ˆå¤šæ–¹æ³•å…¶å®å¾ˆå°‘ç”¨æˆ–è€…æ ¹æœ¬ç”¨ä¸ä¸Šã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ¯æ¬¡æ¶ˆæ¯æ¥æ—¶ï¼Œæˆ‘ä»¬éƒ½æ˜¯methodListsä¸­éå†ä¸€éï¼Œæ€§èƒ½åŠ¿å¿…å¾ˆå·®ã€‚è¿™æ—¶ï¼Œ``cache``å°±æ´¾ä¸Šç”¨åœºäº†ã€‚åœ¨æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨è¿‡ä¸€ä¸ªæ–¹æ³•åï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«ç¼“å­˜åˆ°``cache``åˆ—è¡¨ä¸­ï¼Œä¸‹æ¬¡è°ƒç”¨çš„æ—¶å€™runtimeå°±ä¼šä¼˜å…ˆå»cacheä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ``cache``æ²¡æœ‰ï¼Œæ‰å»``methodLists``ä¸­æŸ¥æ‰¾æ–¹æ³•ã€‚è¿™æ ·ï¼Œå¯¹äºé‚£äº›ç»å¸¸ç”¨åˆ°çš„æ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æé«˜äº†è°ƒç”¨çš„æ•ˆç‡ã€‚
4. ``version``ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­—æ®µæ¥æä¾›ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™å¯¹äºå¯¹è±¡çš„åºåˆ—åŒ–éå¸¸æœ‰ç”¨ï¼Œå®ƒå¯æ˜¯è®©æˆ‘ä»¬è¯†åˆ«å‡ºä¸åŒç±»å®šä¹‰ç‰ˆæœ¬ä¸­å®ä¾‹å˜é‡å¸ƒå±€çš„æ”¹å˜ã€‚

å‚è€ƒï¼š

[Objective-C Runtime è¿è¡Œæ—¶ä¹‹ä¸€ï¼šç±»ä¸å¯¹è±¡](http://southpeak.github.io/2014/10/25/objective-c-runtime-1/)

********

**å®ä¾‹å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Ÿ**

å®ä¾‹å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª``id``ç±»å‹çš„å¯¹è±¡ï¼ŒæŸ¥çœ‹``objc.h``ä¸­å¯¹``id``çš„æè¿°ï¼š

```
#if !OBJC_TYPES_DEFINED
/// An opaque type that represents an Objective-C class.
typedef struct objc_class *Class;

/// Represents an instance of a class.
struct objc_object {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
};

/// A pointer to an instance of a class.
typedef struct objc_object *id;
#endif

```

æŸ¥çœ‹æºæ–‡ä»¶ï¼Œå¯ä»¥çœ‹å‡º``id``å…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡å‘``objc_object``ç»“æ„ä½“æŒ‡é’ˆï¼Œå®ƒåŒ…å«ä¸€ä¸ª``Class`` isa æˆå‘˜ã€‚æ‰€ä»¥å®ä¾‹å¯¹è±¡çš„æ•°æ®ç»“æ„å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª``Class``çš„æ•°æ®ç»“æ„ã€‚

*******

**å…ƒç±»å¯¹è±¡çš„æ•°æ®ç»“æ„?**

meta-class æ˜¯ Class å¯¹è±¡çš„ç±»ã€‚æ¯ä¸ª Class éƒ½æœ‰ä¸ªä¸åŒçš„è‡ªå·±çš„ meta-classï¼ˆå› æ­¤æ¯ä¸ª Class éƒ½å¯ä»¥æœ‰ä¸€ä¸ªè‡ªå·±ä¸åŒçš„æ–¹æ³•åˆ—è¡¨ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªç±»çš„ Class ä¸å®Œå…¨ç›¸åŒã€‚

å‚è€ƒï¼š

[Objective-C ä¸­çš„ Meta-class æ˜¯ä»€ä¹ˆï¼Ÿ](http://www.cocoachina.com/industry/20131210/7508.html)

*****

**``Category`` çš„å®ç°åŸç†ï¼Ÿä»¥åŠå¦‚ä½•å®ç°æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Ÿ**

å‚è€ƒï¼š

[ä»æºç è§£è¯»Categoryå®ç°åŸç†](https://juejin.im/post/5a9d14856fb9a028e52d5568)

[æ·±å…¥ç†è§£Objective-Cï¼šCategory](https://tech.meituan.com/DiveIntoCategory.html)

******

**å¦‚ä½•è¿ç”¨ ``Runtime`` å­—å…¸è½¬æ¨¡å‹ï¼Ÿ**

å‚è€ƒï¼š

[åˆ©ç”¨è¿è¡Œæ—¶(runtime)å­—å…¸è½¬æ¨¡å‹](http://www.cnblogs.com/haojuncong/p/4539711.html)

ç®€å•çš„ç‰ˆæœ¬å¦‚ä¸Šï¼Œå…¶ä»–è¿˜æœ‰ä¸€äº›å…³é”®å­—çš„ä¸èƒ½ä½œä¸ºkeyå€¼å¾—è¿˜è¦æ˜ å°„ä¸€ä¸‹çš„ã€‚è¿˜æœ‰åµŒå¥—çš„ç­‰ç­‰å…¶ä»–çš„è¦è€ƒè™‘ã€‚

*****

**``Category`` æœ‰å“ªäº›ç”¨é€”ï¼Ÿ**

1ï¼‰æ— éœ€åˆ›å»ºç»§æ‰¿ç±»ï¼Œå®ç°å¯¹å·²æœ‰ç±»æ‰©å±•ã€‚å¹¶ä¸”å¯ä»¥è¢«æ‰©å±•çš„ç±»çš„æ‰€æœ‰å­ç±»è‡ªåŠ¨ç»§æ‰¿ã€‚

2ï¼‰å¯ä»¥ç”¨æ¥ä¿®å¤æ²¡æœ‰æºç ç±»çš„bugã€‚

3ï¼‰å¯¹äºä¸€ä¸ªç±»å¤šä¸ªå¼€å‘äººå‘˜ç»´æŠ¤çš„æƒ…å†µï¼Œå¯ä»¥æ ¹æ®ä¸åŒç”¨é€”åˆ›å»ºä¸åŒåˆ†ç±»ã€‚

æ³¨æ„ç‚¹ï¼š

1ï¼‰ä¸èƒ½åœ¨åˆ†ç±»ä¸­é‡å†™ç³»ç»Ÿæ–¹æ³•ï¼Œå› ä¸ºä¼šæŠŠç³»ç»Ÿçš„åŠŸèƒ½ç»™è¦†ç›–æ‰ï¼Œè€Œä¸”åˆ†ç±»ä¸­ä¸èƒ½è°ƒç”¨superã€‚ä½†æ˜¯ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç”¨æ¥ä¿®å¤ï¼Œæ²¡æœ‰æºç çš„ç±»ä¸­æ–¹æ³•æœ‰Bugçš„æƒ…å†µã€‚

*****

**``Category`` å’Œ ``Extension`` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

1)``Category`` çš„åŠ è½½åœ¨**è¿è¡Œæ—¶**ï¼Œ``Extension`` çš„åŠ è½½åœ¨**ç¼–è¯‘æ—¶**ã€‚

2) ``Extension`` ä¸èƒ½ç»™æ²¡æœ‰æºç çš„ç±»æ·»åŠ æ–¹æ³•ã€‚

3) ``Extension`` æ˜¯ä¸€ä¸ªåŒ¿åçš„ ``Category`` ã€‚

****

**è¯´ä¸€ä¸‹ ``Method Swizzling``? è¯´ä¸€ä¸‹åœ¨å®é™…å¼€å‘ä¸­ä½ åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨è¿‡?**

å‚è€ƒï¼š

[Method Swizzling](http://nshipster.cn/method-swizzling/)

å…³äº``Method Swizzling``è¸©è¿‡çš„å‘ï¼Œ

å‚è€ƒè¿™é‡Œ

[Method Swizzling](http://melodyofnight.github.io/2017/08/30/Method-Swizzing/#more)

****

**å¦‚ä½•å®ç°åŠ¨æ€æ·»åŠ æ–¹æ³•å’Œå±æ€§ï¼Ÿ**

```
//åŠ¨æ€åˆ›å»ºç±»
Class person = objc_allocateClassPair([NSObject class], "Person", 0);
//æ·»åŠ å˜é‡
class_addIvar(person, "name", sizeof(NSString *), 0, "@");
//æ·»åŠ å‡½æ•°  sayHi
class_addMethod(person, @selector(sayHi:), (IMP)sayHi, "v@:");
objc_registerClassPair(person);
//åˆå§‹åŒ–ä¸€ä¸ªpersonå¯¹è±¡
id Tom = [[person alloc] init];
[Tom setValue:@"Tom" forKey:@"name"];
[Tom sayHi:@"Jeck"];

```

ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡``objc_allocateClassPair()``åˆ›å»ºäº†ä¸€ä¸ªç»§æ‰¿``NSObject``çš„``person``çš„å­ç±»ï¼Œç„¶åé€šè¿‡``objc_registerClassPair()``è¿™ä¸ªå‡½æ•°æ³¨å†Œäº†``person``ç±»ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»äº†ï¼Œä½¿ç”¨ä¹‹å‰æˆ‘ä»¬åœ¨ç»™``person``ç±»ä¸­æ·»åŠ ä¸€ä¸ª``name``å±æ€§å’Œ``sayHi:``æ–¹æ³•ï¼Œåˆ†åˆ«é€šè¿‡``class_addIvar()``å’Œ``class_addMethod()``æ¥æ·»åŠ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°æˆ‘ä»¬æ·»åŠ çš„``sayHi:``æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```
//è¿™ä¸ªå‡½æ•°å¿…é¡»å†™ï¼Œè¦ä¸ç„¶xcodeä¼šæŠ¥é”™ï¼Œå®é™…è¿è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¸ä¼šè°ƒç”¨çš„
-(void)sayHi:(NSString *)name
{
    
}

//è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
static void sayHi(id self, SEL _cmd, NSString *name)
{
    Ivar n = class_getInstanceVariable([self class], "name");
    id a = object_getIvar(self, n);
    NSLog(@"hello %@,my name is %@",name,a);
}

```

``static void sayHi(id self, SEL _cmd, NSString *name)``è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬è¿è¡Œæ—¶å€™è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶ä¸­``self``ä½¿æˆ‘ä»¬ä½¿ç”¨``person``åˆ›å»ºçš„å¯¹è±¡``Tom``,``_cmd``æ˜¯è°ƒç”¨çš„æ–¹æ³•åï¼Œ``name``å°±æ˜¯ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªå‚æ•°ï¼Œå¯ä»¥å†™æˆ``static void sayHi(id self, SEL _cmd, NSString *name,...)``çœç•¥å·å¯ä»¥å¡«å†™ä½ æ„¿æ„æ·»åŠ çš„å‚æ•°ã€‚

è¿™æ ·æˆ‘ä»¬å°±åˆ©ç”¨runtimeåŠ¨æ€çš„åˆ›å»ºäº†ä¸€ä¸ªpersonç±»ï¼ŒåŒ…æ‹¬äº†nameå±æ€§å’ŒsayHi:æ–¹æ³•ï¼Œè¿è¡Œå¦‚ç»“æœå¦‚ä¸‹ï¼š

```
RunTimeDemo[46329:7242266] hello Jeck,my name is Tom
```

å‚è€ƒï¼š

[runtimeå¸¸ç”¨æ–¹æ³•](https://github.com/coolnameismy/ios-tips/blob/master/0_Foundation/runtime%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95.md)

****

**è¯´ä¸€ä¸‹å¯¹ isa æŒ‡é’ˆçš„ç†è§£ï¼Œ å¯¹è±¡çš„isa æŒ‡é’ˆæŒ‡å‘å“ªé‡Œï¼Ÿï¼ˆæ³¨æ„åŒºåˆ†ä¸åŒå¯¹è±¡ï¼‰**


ç½‘ä¸Šæœ‰2ç§è¯´æ³•ï¼š

1ï¼‰``isa`` æ˜¯æŒ‡å‘å…ƒç±»çš„æŒ‡é’ˆï¼Œä¸äº†è§£å…ƒç±»çš„å¯ä»¥çœ‹ [Objective-C ä¸­çš„ Meta-class æ˜¯ä»€ä¹ˆï¼Ÿ](http://www.cocoachina.com/industry/20131210/7508.html)

2) ä»»ä½•ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿äº†``NSObject``çš„ç±»ï¼Œå®ƒçš„å®ä¾‹å¯¹è±¡(instacne objec)ä¸­éƒ½æœ‰ä¸€ä¸ª``isa``æŒ‡é’ˆï¼ŒæŒ‡å‘å®ƒçš„ç±»å¯¹è±¡(class object)ã€‚è¿™ä¸ªç±»å¯¹è±¡(class object)ä¸­å­˜å‚¨äº†å…³äºè¿™ä¸ªå®ä¾‹å¯¹è±¡(instace object)æ‰€å±çš„ç±»çš„å®šä¹‰çš„ä¸€åˆ‡ï¼šåŒ…æ‹¬**å˜é‡**ï¼Œ**æ–¹æ³•**ï¼Œ**éµå®ˆçš„åè®®**ç­‰ç­‰ã€‚

å‚è€ƒï¼š

[Objective-Cå†…å­˜å¸ƒå±€](http://www.cnblogs.com/csutanyu/archive/2011/12/12/Objective-C_memory_layout.html)

[Objective-C ä¸­çš„ Meta-class æ˜¯ä»€ä¹ˆï¼Ÿ](http://www.cocoachina.com/industry/20131210/7508.html)

****

**``Obj-C`` ä¸­çš„ç±»ä¿¡æ¯å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿ**

ç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»ã€‚

å½“å‰ç±»çš„ä¿¡æ¯éƒ½åœ¨ ``data`` é‡Œã€‚çœ‹çœ‹æºç å°±çŸ¥é“äº†ã€‚

*******

**ä¸€ä¸ª NSObject å¯¹è±¡å ç”¨å¤šå°‘å†…å­˜ç©ºé—´ï¼Ÿ**

é€šè¿‡ ``size_t class_getInstanceSize ( Class cls )``æ¥å£å¯ä»¥è·å–``NSObject`` å¯¹è±¡å ç”¨å†…å­˜ç©ºé—´å¤§å°ã€‚

```
size_t z = class_getInstanceSize([NSObject class]);

//è¾“å‡º 
(lldb) p z
(size_t) $0 = 8

å•ä½æ˜¯ byte
```

****

**è¯´ä¸€ä¸‹å¯¹ ``class_rw_t`` çš„ç†è§£ï¼Ÿ**

``rw``ä»£è¡¨å¯è¯»å¯å†™ã€‚

``ObjC`` ç±»ä¸­çš„å±æ€§ã€æ–¹æ³•è¿˜æœ‰éµå¾ªçš„åè®®ç­‰ä¿¡æ¯éƒ½ä¿å­˜åœ¨ ``class_rw_t`` ä¸­ï¼š

```
struct class_rw_t {  
    uint32_t flags;
    uint32_t version;

    const class_ro_t *ro;

    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    Class firstSubclass;
    Class nextSiblingClass;
};

```

å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆ ``ro``ï¼Œå…¶ä¸­å­˜å‚¨äº†å½“å‰ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šçš„å±æ€§ã€æ–¹æ³•ä»¥åŠéµå¾ªçš„åè®®

å‚è€ƒï¼š

[æ·±å…¥è§£æ Objective-C ä¸­æ–¹æ³•çš„ç»“æ„](http://www.cocoachina.com/ios/20160518/16322.html)

**********

**è¯´ä¸€ä¸‹å¯¹ ``class_ro_t`` çš„ç†è§£ï¼Ÿ**

å‚¨äº†å½“å‰ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šçš„å±æ€§ã€æ–¹æ³•ä»¥åŠéµå¾ªçš„åè®®ã€‚

```
struct class_ro_t {  
    uint32_t flags;
    uint32_t instanceStart;
    uint32_t instanceSize;
    uint32_t reserved;

    const uint8_t * ivarLayout;

    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;
};
```

å‚è€ƒï¼š

[æ·±å…¥è§£æ Objective-C ä¸­æ–¹æ³•çš„ç»“æ„](http://www.cocoachina.com/ios/20160518/16322.html)

*****

**è¯´ä¸€ä¸‹ ``Runtime`` æ¶ˆæ¯è§£æå’Œè½¬å‘**

å…ˆçœ‹ä¸€ä¸‹æµç¨‹å›¾ï¼š

<!-- more -->

![](../../../../images/objc_msgSendæµç¨‹.png)

åœ¨ Object-C ä¸­è°ƒç”¨æ–¹æ³•æœ€ç»ˆéƒ½ä¼šç¿»è¯‘æˆè°ƒç”¨æ–¹æ³•å®ç°çš„çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¼ é€’ç»™å®ƒä¸€ä¸ª**å¯¹è±¡æŒ‡é’ˆ**ã€**ä¸€ä¸ªé€‰æ‹©å™¨**å’Œ**ä¸€ç»„å‡½æ•°å‚æ•°**ã€‚

objc_msgSend çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š

1. æ£€æŸ¥æ¥å—å¯¹è±¡æ˜¯å¦ä¸º``nil`` ã€‚å¦‚æœæ˜¯ï¼Œè°ƒç”¨``nil``å¤„ç†ç¨‹åºã€‚
2. åœ¨åƒåœ¾æ”¶é›†ç¯å¢ƒä¸­ï¼ˆios ä¸æ”¯æŒï¼Œå†™åœ¨è¿™é‡Œæ˜¯ä¸ºäº†å†…å®¹çš„å®Œæ•´æ€§ï¼‰ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰é”»ç‚¼é€‰æ‹©å™¨ï¼ˆretainã€releaseã€autoreleaseã€retainCountï¼‰ï¼Œå¦‚æœæœ‰ï¼Œè¿”å› selfã€‚æ˜¯çš„ï¼Œè¿™æ„å‘³ç€åœ¨åƒåœ¾æ”¶é›†ç¯å¢ƒä¸­ retainCount ä¼šè¿”å› selfï¼Œä¸è¿‡ä½ åº”è¯¥ç”¨ä¸åˆ°ã€‚
3. æ£€æŸ¥ç±»ç¼“å­˜ä¸­æ˜¯ä¸æ˜¯å·²ç»æœ‰æ–¹æ³•å®ç°äº†ï¼Œæœ‰çš„è¯ï¼Œç›´æ¥è°ƒç”¨ã€‚
4. æ¯”è¾ƒè¯·æ±‚çš„é€‰æ‹©å™¨å’Œç±»å®šä¹‰çš„é€‰æ‹©å™¨ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œè°ƒç”¨æ–¹æ³•å®ç°ã€‚
5. æ¯”è¾ƒè¯·æ±‚çš„é€‰æ‹©å™¨å’Œçˆ¶ç±»ä¸­å®šä¹‰çš„é€‰æ‹©å™¨ï¼Œç„¶åæ˜¯çˆ¶ç±»çš„çˆ¶ç±»ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœæ‰¾åˆ°é€‰æ‹©å™¨ï¼Œè°ƒç”¨æ–¹æ³•å®ç°ã€‚
6. è°ƒç”¨ ``resolveInstanceMethod:`` ( æˆ–è€… ``resolveClassMethod:`` )ã€‚å¦‚æœå®ƒè¿”å› ``YES`` ï¼Œé‚£ä¹ˆé‡æ–°å¼€å§‹ã€‚è¿™ä¸€æ¬¡å¯¹è±¡ä¼šç›¸åº”è¿™ä¸ªé€‰æ‹©å™¨ï¼Œä¸€èˆ¬æ˜¯å› ä¸ºå®ƒå·²ç»è°ƒç”¨è¿‡ ``class_addMethod``ã€‚
7. è°ƒç”¨ ``forwardingTargetForSelector:``ï¼Œå¦‚æœè¿”å›``é nil``ï¼Œé‚£å°±æŠŠæ¶ˆæ¯å‘é€åˆ°è¿”å›çš„å¯¹è±¡ä¸Šã€‚**è¿™é‡Œä¸è¦è¿”å› selfï¼Œå¦åˆ™ä¼šå½¢æˆæ­»å¾ªç¯**ã€‚
8. è°ƒç”¨ ``methodSignatureForSelector:``ï¼Œå¦‚æœè¿”å›ä¸€ä¸ª``é nil``ï¼Œåˆ›å»ºä¸€ä¸ª ``NSInvocation`` å¹¶ä¼ ç»™ ``forwardInvocation``ã€‚
9. è°ƒç”¨ ``doesNotRecognizeSelector:``ï¼Œé»˜è®¤æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚


ä¾‹å­ğŸŒ°

**Xcodeä½•æ—¶ä¼šæŠ¥``unrecognized selector``çš„é”™è¯¯**

```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    AAPerson *person = [[Person alloc] init];
    [person test];
}

```
å½“å‘``AAPerson``å‘é€``test``è¿™ä¸ªæ¶ˆæ¯æ—¶ï¼Œ``runtime``ä¼šæ ¹æ®å¯¹è±¡çš„``isaæŒ‡é’ˆ``æ‰¾åˆ°è¯¥å¯¹è±¡å®é™…æ‰€å±çš„ç±»ï¼Œç„¶ååœ¨è¯¥ç±»çš„æ–¹æ³•åˆ—è¡¨ä»¥åŠçˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œé¢æ‰¾ç›¸åº”çš„æ–¹æ³•è¿è¡Œï¼Œå¦‚æœåœ¨æœ€é¡¶å±‚çš„çˆ¶ç±»ä¸­ä¾ç„¶æ‰¾ä¸åˆ°ç›¸åº”çš„æ–¹æ³•å®ç°æ—¶ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶å°±ä¼šæŠ¥``unrecognized selector sent to``çš„é”™è¯¯å¹¶ä¸”å´©æºƒï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œobjcçš„è¿è¡Œæ—¶ç»™å‡ºäº†**ä¸‰æ¬¡**é¿å…ç¨‹åºå´©æºƒçš„æœºä¼šã€‚

 **1ã€Method resolution**

objcè¿è¡Œæ—¶ä¼šè°ƒç”¨``+resolveInstanceMethod:``æˆ–è€…``+resolveClassMethod:``ï¼Œè®©æˆ‘ä»¬æœ‰æœºä¼šæä¾›ä¸€ä¸ªå‡½æ•°å®ç°è€Œä¸å¯¼è‡´ç¨‹åºå´©æºƒï¼Œå¦‚æœåœ¨è¿™é‡Œé¢æ·»åŠ äº†å‡½æ•°ï¼Œç³»ç»Ÿå°±ä¼šé‡æ–°å¯åŠ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ï¼Œå¦åˆ™å°±ä¼šè¿›å…¥åˆ°æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘æµç¨‹ã€‚

```
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    if (sel == NSSelectorFromString(@"test")) {
        /**
          class: ç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•
          SEL: æ·»åŠ å“ªä¸ªæ–¹æ³•
          IMP: æ–¹æ³•å®ç° => å‡½æ•° => å‡½æ•°å…¥å£ => å‡½æ•°å
          type: æ–¹æ³•ç±»å‹ï¼švoidç”¨væ¥è¡¨ç¤ºï¼Œidå‚æ•°ç”¨@æ¥è¡¨ç¤ºï¼ŒSELç”¨:æ¥è¡¨ç¤º
         */
        class_addMethod(self, sel, (IMP)test, "v@:@");
        return YES;
    }else {
        return [super resolveClassMethod:sel];
    }
}

void test(id self, SEL _cmd, NSNumber *meter) {
    NSLog(@"æµ‹è¯• - AAPerson");
}

```

**2ã€Fast forwarding**

å¦‚æœ``ç›®æ ‡å¯¹è±¡``å®ç°äº†``-forwardingTargetForSelector:``çš„æ–¹æ³•ï¼Œruntimeå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç»™æˆ‘ä»¬ä¸€ä¸ªæœºä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯è½¬å‘ç»™å…¶ä»–çš„å¯¹è±¡ï¼Œ**åªè¦è¿™ä¸ªæ–¹æ³•è¿”å›å€¼ä¸æ˜¯nilå’Œself**ï¼Œæ•´ä¸ªæ¶ˆæ¯å‘é€çš„è¿‡ç¨‹å°±ä¼šè¢«é‡å¯ï¼Œè¿™æ—¶å‘é€çš„å¯¹è±¡ä¼šå˜æˆæˆ‘ä»¬è¿”å›çš„è¿™ä¸ªå¯¹è±¡ï¼Œå¦åˆ™å°±ä¼šç§»åˆ°ä¸‹ä¸€æ­¥ã€‚

```
- (id)forwardingTargetForSelector:(SEL)aSelector {
    AATarget *target = [[AATarget alloc] init];
    if ([target respondsToSelector:aSelector]) {
        return target; // å°±ä¼šå»è°ƒç”¨AATargeté‡Œé¢çš„testæ–¹æ³•
    }else {
        return [super forwardingTargetForSelector: aSelector];
    }
}
```

**3ã€Normal Fowarding**

å¦‚æœä¸Šé¢ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰è¢«å®ç°çš„è¯ï¼Œå°±ä¼šæ¥åˆ°ç¬¬ä¸‰æ­¥ â€”â€” æ™®é€šè½¬å‘ï¼Œè¿™æ˜¯runtimeç»™æˆ‘ä»¬æœ€åä¸€æ¬¡é¿å…å´©æºƒçš„æœºä¼šï¼Œé¦–å…ˆå®ƒä¼š``-methodSignatureForSelector:``æ¥è·å¾—å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ï¼Œå¦‚æœè¿”å›å€¼ä¸º``nil``ï¼Œåˆ™runtimeä¼šå‘å‡º-``doesNotRecognizeSelector:`` çš„æ¶ˆæ¯ï¼Œç¨‹åºå´©æºƒã€‚å¦‚æœè¿”å›äº†ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œruntimeä¼šåˆ›å»ºä¸€ä¸ª``NSInvocation``å¯¹è±¡å¹¶å‘é€-``forwardInvocation:``çš„æ¶ˆæ¯ç»™ç›®æ ‡å¯¹è±¡ã€‚

```
- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector {
    NSMethodSignature *signature = [NSMethodSignature signatureWithObjCTypes:"v@:"];
    return signature;
}

- (void)forwardInvocation:(NSInvocation *)anInvocation {
    SEL selector = [anInvocation selector];// anInvocationé‡Œé¢ä¿å­˜çš„æ˜¯selectorï¼targetï¼å‚æ•°
    AATarget *target = [[WWTarget alloc] init];
    if ([target respondsToSelector:selector]) {
        [anInvocation invokeWithTarget:target];
    }    
}

```
å¦‚æœä¸Šé¢çš„ä¸‰æ­¥éƒ½æ²¡æœ‰å®ç°çš„è¯ï¼Œå°±ä¼šè°ƒç”¨``-doesNotRecognizeSelector:``ï¼Œç¨‹åºå´©æºƒã€‚

******

**å¦‚ä½•è¿ç”¨ ``Runtime`` å­—å…¸è½¬æ¨¡å‹?**

``Runtime`` éå† ``ivar_list``,ç»“åˆ ``KVC`` èµ‹å€¼ã€‚

Note:

å¯¹äºç‰¹æ®Šçš„(å¦‚id)æˆ–è€…è‡ªå®šä¹‰çš„å±æ€§å’Œå­—å…¸ä¸­çš„keyä¸ä¸€æ ·çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œè¿™æ—¶å€™éœ€è¦é‡å†™``- (void)setValue:(id)value forUndefinedKey:(NSString *)key``æ–¹æ³•ã€‚

å‚è€ƒï¼š

[åˆ©ç”¨Runtimeå®ç°ç®€å•çš„å­—å…¸è½¬æ¨¡å‹](https://lzascott.github.io/2016/06/19/%E5%88%A9%E7%94%A8RunTime%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%AD%97%E5%85%B8%E8%BD%AC%E6%A8%A1%E5%9E%8B/)

****

**å¦‚ä½•è¿ç”¨ Runtime è¿›è¡Œæ¨¡å‹çš„å½’è§£æ¡£ï¼Ÿ**

``Runtime`` éå† ``ivar_list``ã€‚

å‚è€ƒï¼š

[iOS - runtimeå¿«é€Ÿå½’è§£æ¡£](https://blog.csdn.net/coderMy/article/details/54590147)

****

**åœ¨ Obj-C ä¸­ä¸ºä»€ä¹ˆå«å‘æ¶ˆæ¯è€Œä¸å«å‡½æ•°è°ƒç”¨ï¼Ÿ**

ç»“åˆ ``objc_msgsend`` è®²ä¸€ä¸‹ï¼Œæ¥æ”¶æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚

****

**è¯´ä¸€ä¸‹ Runtime çš„æ–¹æ³•ç¼“å­˜ï¼Ÿå­˜å‚¨çš„å½¢å¼ã€æ•°æ®ç»“æ„ä»¥åŠæŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Ÿ**


``cache_t``å¢é‡æ‰©å±•çš„å“ˆå¸Œè¡¨ç»“æ„ã€‚å“ˆå¸Œè¡¨å†…éƒ¨å­˜å‚¨çš„ ``bucket_t``ã€‚

- å¦‚æœæ˜¯æœ‰åºæ–¹æ³•åˆ—è¡¨ï¼Œé‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾

- å¦‚æœæ˜¯æ— åºæ–¹æ³•åˆ—è¡¨ï¼Œç›´æ¥éå†æŸ¥æ‰¾

****


## 0x03 RunLoop

**``Runloop`` å’Œçº¿ç¨‹çš„å…³ç³»**

- ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª ``Runloop``ã€‚

- ä¸»çº¿ç¨‹çš„é»˜è®¤å°±æœ‰äº† ``Runloop``ã€‚

- å­çº¿ç¨‹çš„ ``Runloop`` ä»¥æ‡’åŠ è½½çš„å½¢å¼åˆ›å»ºã€‚

- ``Runloop`` å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„å¯å˜å­—å…¸é‡Œï¼Œçº¿ç¨‹æ˜¯ ``key`` ï¼Œ``Runloop`` æ˜¯ ``value``

******

**è®²ä¸€ä¸‹ Runloop çš„ Mode?(è¶Šè¯¦ç»†è¶Šå¥½)**

è‹¹æœæ–‡æ¡£ä¸­æåˆ°çš„ Mode æœ‰äº”ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š

- NSDefaultRunLoopMode
- NSConnectionReplyMode
- NSModalPanelRunLoopMode
- NSEventTrackingRunLoopMode
- NSRunLoopCommonModes

iOS ä¸­å…¬å¼€æš´éœ²å‡ºæ¥çš„åªæœ‰ ``NSDefaultRunLoopMode`` å’Œ ``NSRunLoopCommonModes``ã€‚ ``NSRunLoopCommonModes`` å®é™…ä¸Šæ˜¯ä¸€ä¸ª ``Mode`` çš„é›†åˆï¼Œé»˜è®¤åŒ…æ‹¬ ``NSDefaultRunLoopMode`` å’Œ ``NSEventTrackingRunLoopMode``ã€‚

å‚è€ƒï¼š

[Runloop Â· ç¬”è¯•é¢è¯•çŸ¥è¯†æ•´ç†](https://hit-alibaba.github.io/interview/iOS/ObjC-Basic/Runloop.html)

****

**è®²ä¸€ä¸‹ Observer ï¼Ÿï¼ˆModeä¸­çš„é‡ç‚¹ï¼‰**

```
typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry         = (1UL << 0), // å³å°†è¿›å…¥Loop
    kCFRunLoopBeforeTimers  = (1UL << 1), // å³å°†å¤„ç† Timer
    kCFRunLoopBeforeSources = (1UL << 2), // å³å°†å¤„ç† Source
    kCFRunLoopBeforeWaiting = (1UL << 5), // å³å°†è¿›å…¥ä¼‘çœ 
    kCFRunLoopAfterWaiting  = (1UL << 6), // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopExit          = (1UL << 7), // å³å°†é€€å‡ºLoop
};
```

****

**è®²ä¸€ä¸‹ Runloop çš„å†…éƒ¨å®ç°é€»è¾‘ï¼Ÿï¼ˆè¿è¡Œè¿‡ç¨‹ï¼‰**

å‚è€ƒï¼š

[æ·±å…¥ç†è§£RunLoop](https://blog.ibireme.com/2015/05/18/runloop/)

****

**ä½ æ‰€çŸ¥çš„å“ªäº›ä¸‰æ–¹æ¡†æ¶ä½¿ç”¨äº† Runloop?ï¼ˆAFNetworkingã€Texture ç­‰)**

****

**è§£é‡Šä¸€ä¸‹ ``äº‹ä»¶å“åº”`` çš„è¿‡ç¨‹**

è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª ``Source1`` (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º ``__IOHIDEventSystemClientQueueCallback()``ã€‚

å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± ``IOKit.framework`` ç”Ÿæˆä¸€ä¸ª ``IOHIDEvent`` äº‹ä»¶å¹¶ç”± ``SpringBoard`` æ¥æ”¶ã€‚è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒè¿™é‡Œã€‚``SpringBoard`` åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ ``Event``ï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„ App è¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª ``Source1`` å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ ``_UIApplicationHandleEventQueue()`` è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚

``_UIApplicationHandleEventQueue()`` ä¼šæŠŠ ``IOHIDEvent`` å¤„ç†å¹¶åŒ…è£…æˆ ``UIEvent`` è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« **UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow** ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚

è¯¦ç»†å‚è€ƒï¼ˆæ¨èé˜…è¯»ï¼‰ï¼š

[iOS ç‚¹å‡»äº‹ä»¶ä¼ é€’åŠå“åº”](http://blog.flight.dev.qunar.com/2016/10/28/ios-event-mechanism-summary/)

****

**è§£é‡Šä¸€ä¸‹ æ‰‹åŠ¿è¯†åˆ« çš„è¿‡ç¨‹ï¼Ÿ**

å½“ä¸Šé¢çš„ ``_UIApplicationHandleEventQueue()``è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ ``Cancel`` å°†å½“å‰çš„ ``touchesBegin/Move/End`` ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ ``UIGestureRecognizer`` æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚

è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª ``Observer`` ç›‘æµ‹ ``BeforeWaiting`` (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ª ``Observer`` çš„å›è°ƒå‡½æ•°æ˜¯ ``_UIGestureRecognizerUpdateObserver()``ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ ``GestureRecognizer``ï¼Œå¹¶æ‰§è¡Œ``GestureRecognizer`` çš„å›è°ƒã€‚

å½“æœ‰ ``UIGestureRecognizer`` çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚

****

**è§£é‡Šä¸€ä¸‹ GCD åœ¨ Runloop ä¸­çš„ä½¿ç”¨ï¼Ÿ**

1ã€RunLoop çš„è¶…æ—¶æ—¶é—´

è¿™æ˜¯ ``RunLoop``çš„ APIï¼š

``` 
//modeé»˜è®¤ä¸ºdefaultModeã€è¶…æ—¶æ—¶é—´æ˜¯100äº¿ç§’ã€false
void CFRunLoopRun(void)
// å¯ä»¥è®¾ç½®modeã€runloop è¶…æ—¶æ—¶é—´ã€æ˜¯å¦å¤„ç†å®Œsourceç«‹åˆ»è¿”å›
SInt32 CFRunLoopRunInMode(CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled)

```

``RunLoop`` çš„è¶…æ—¶æ—¶é—´å°±æ˜¯ä½¿ç”¨ ``GCD`` ä¸­çš„ ``dispatch_source_t``æ¥å®ç°çš„ã€‚

2ã€æ‰§è¡Œ``GCD MainQueue``ä¸Šçš„å¼‚æ­¥ä»»åŠ¡ï¼Œå³ï¼š``dispatch_async(dispatch_get_main_queue(), block)``äº§ç”Ÿçš„ä»»åŠ¡ã€‚

å‚è€ƒï¼š

[RunLoopæ€»ç»“ï¼šRunLoop ä¸GCD ã€Autorelease Poolä¹‹é—´çš„å…³ç³»](https://www.jianshu.com/p/e259bf7ab297)

****

**è§£é‡Šä¸€ä¸‹ NSTimerï¼Œä»¥åŠ NSTimer çš„å¾ªç¯å¼•ç”¨**

``NSTimer`` å…¶å®å°±æ˜¯ ``CFRunLoopTimerRef``ï¼Œä»–ä»¬ä¹‹é—´æ˜¯ ``toll-free bridged ``çš„ã€‚ä¸€ä¸ª ``NSTimer`` æ³¨å†Œåˆ° ``RunLoop`` åï¼Œ``RunLoop`` ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚ä¾‹å¦‚ ``10:00``, ``10:10``, ``10:20`` è¿™å‡ ä¸ªæ—¶é—´ç‚¹ã€‚``RunLoop`` ä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ª``Timer``ã€‚``Timer`` æœ‰ä¸ªå±æ€§å«åš ``Tolerance (å®½å®¹åº¦)``ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚

å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚



å¼•èµ· ``NSTimer`` å¾ªç¯å¼•ç”¨çš„ä¸»è¦æ˜¯æ•è·äº†``self``äº†ï¼Œå¦‚ä¸‹ï¼š

```
self.timer = [NSTimer scheduledTimerWithTimeInterval:1 
target:self selector:@selector(timerAction:) userInfo:nil repeats:true];
```

å°±ç®—æ˜¯å°†ä¸Šé¢çš„``self``æ”¹ä¸º``weakSelf``ä¹Ÿæ²¡æœ‰ç”¨ï¼Œæœ€å¥½çš„è§£å†³åŠæ³•æ˜¯ç”¨``GCD``çš„``dispatch_source``è§£å†³ã€‚

å¦‚ä¸‹ï¼š

```
#import "RNTimer.h"

@interface RNTimer ()
@property (nonatomic, readwrite, copy) dispatch_block_t block;
@property (nonatomic, readwrite, assign) dispatch_source_t source;
@end

@implementation RNTimer
@synthesize block = _block;
@synthesize source = _source;

+ (RNTimer *)repeatingTimerWithTimeInterval:(NSTimeInterval)seconds
                                      block:(void (^)(void))block {
  NSParameterAssert(seconds);
  NSParameterAssert(block);

  RNTimer *timer = [[self alloc] init];
  timer.block = block;
  timer.source = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,
                                        0, 0,
                                        dispatch_get_main_queue());
  uint64_t nsec = (uint64_t)(seconds * NSEC_PER_SEC);
  dispatch_source_set_timer(timer.source,
                            dispatch_time(DISPATCH_TIME_NOW, nsec),
                            nsec, 0);
  dispatch_source_set_event_handler(timer.source, block);
  dispatch_resume(timer.source);
  return timer;
}

- (void)invalidate {
  if (self.source) {
    dispatch_source_cancel(self.source);
    dispatch_release(self.source);
    self.source = nil;
  }
  self.block = nil;
}

- (void)dealloc {
  [self invalidate];
}

- (void)fire {
  self.block();
}

```

å‚è€ƒé“¾æ¥ï¼š

[iOS | å°å¿ƒNSTimerä¸­çš„å†…å­˜æ³„æ¼](https://www.jianshu.com/p/2fe076e5e255)

[RNTimer](https://github.com/rnapier/RNTimer)

æ‹“å±•ï¼š

[NSTimer å¤±æ•ˆ](https://blog.csdn.net/zhonggaorong/article/details/51602090)

[ä»RunLoopæºç æ¢ç´¢NSTimerçš„å®ç°åŸç†](https://www.jianshu.com/p/179603ffb194)

****

**``AFNetworking``ä¸­å¦‚ä½•è¿ç”¨``Runloop``?**
``AFURLConnectionOperation`` è¿™ä¸ªç±»æ˜¯åŸºäº ``NSURLConnection`` æ„å»ºçš„ï¼Œå…¶å¸Œæœ›èƒ½åœ¨åå°çº¿ç¨‹æ¥æ”¶ ``Delegate`` å›è°ƒã€‚ä¸ºæ­¤ ``AFNetworking`` å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨äº†ä¸€ä¸ª ``RunLoop``ï¼š

```
+ (void)networkRequestThreadEntryPoint:(id)__unused object {
    @autoreleasepool {
        [[NSThread currentThread] setName:@"AFNetworking"];
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}

+ (NSThread *)networkRequestThread {
    static NSThread *_networkRequestThread = nil;
    static dispatch_once_t oncePredicate;
    dispatch_once(&oncePredicate, ^{
        _networkRequestThread = [[NSThread alloc] initWithTarget:self selector:@selector(networkRequestThreadEntryPoint:) object:nil];
        [_networkRequestThread start];
    });
    return _networkRequestThread;
}

```
``RunLoop`` å¯åŠ¨å‰å†…éƒ¨å¿…é¡»è¦æœ‰è‡³å°‘ä¸€ä¸ª ``Timer/Observer/Source``ï¼Œæ‰€ä»¥ ``AFNetworking`` åœ¨ ``[runLoop run]`` ä¹‹å‰å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„`` NSMachPort`` æ·»åŠ è¿›å»äº†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨è€…éœ€è¦æŒæœ‰è¿™ä¸ª ``NSMachPort (mach_port)`` å¹¶åœ¨å¤–éƒ¨çº¿ç¨‹é€šè¿‡è¿™ä¸ª ``port`` å‘é€æ¶ˆæ¯åˆ° ``loop`` å†…ï¼›ä½†æ­¤å¤„æ·»åŠ  ``port`` åªæ˜¯ä¸ºäº†è®© ``RunLoop`` ä¸è‡³äºé€€å‡ºï¼Œå¹¶æ²¡æœ‰ç”¨äºå®é™…çš„å‘é€æ¶ˆæ¯ã€‚

```
- (void)start {
    [self.lock lock];
    if ([self isCancelled]) {
        [self performSelector:@selector(cancelConnection) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    } else if ([self isReady]) {
        self.state = AFOperationExecutingState;
        [self performSelector:@selector(operationDidStart) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    }
    [self.lock unlock];
}
```
å½“éœ€è¦è¿™ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œ``AFNetworking`` é€šè¿‡è°ƒç”¨ ``[NSObject performSelector:onThread:..]`` å°†è¿™ä¸ªä»»åŠ¡æ‰”åˆ°äº†åå°çº¿ç¨‹çš„ ``RunLoop`` ä¸­ã€‚

****

**PerformSelector çš„å®ç°åŸç†**

å½“è°ƒç”¨ ``NSObject`` çš„ ``performSelecter:afterDelay:`` åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª ``Timer`` å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ ``RunLoop`` ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ ``RunLoop``ï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚

å½“è°ƒç”¨ ``performSelector:onThread:`` æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª ``Timer`` åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ ``RunLoop`` è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚

å…¶ä»–çš„``performSelector``ç³»åˆ—æ–¹æ³•æ˜¯ç±»ä¼¼çš„

```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self tryPerformSelectorOnMianThread];
    
    __weak typeof(self) weakSelf = self;
    //backGroundThreadå¹¶ä¸ä¼šè¢«è°ƒç”¨åˆ°,è¿™æ˜¯å› ä¸ºï¼Œåœ¨è°ƒç”¨performSelector:onThread: withObject: waitUntilDoneçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªTimerçš„sourceï¼ŒåŠ åˆ°å¯¹åº”çš„RunLoopä¸Šå»ï¼Œç„¶è€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ²¡æœ‰RunLoop
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        [weakSelf tryPerformSelectorOnbackGroundThread1];
    });
    
    //åœ¨tryPerformSelectorOnbackGroundThread1ä¸Šæˆ‘ä»¬æ·»åŠ ä¸ªRunLoop,æ­¤æ—¶backGroundThread2å°±å¯ä»¥è¢«è°ƒç”¨åˆ°
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        [weakSelf tryPerformSelectorOnbackGroundThread2];
    });
    
    //é‚£ä¹ˆä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸­çš„perfom selectorå´èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨å‘¢ï¼Ÿé€šè¿‡ä¸Šé¢çš„ä¾‹å­ç›¸ä¿¡ä½ å·²ç»çŒœåˆ°äº†ï¼Œä¸»çº¿ç¨‹çš„RunLoopæ˜¯ä¸€ç›´å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ—¶å€™ï¼Œæ— éœ€å†æ·»åŠ RunLoopã€‚
    //å°ç»“:å½“perform selectoråœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å¿…é¡»æœ‰ä¸€ä¸ªå¼€å¯çš„runLoop
}

- (void)tryPerformSelectorOnMianThread{
    [self performSelector:@selector(mainThreadMethod) withObject:nil];
}

- (void)tryPerformSelectorOnbackGroundThread1{
    //backGroundThreadå¹¶ä¸ä¼šè¢«è°ƒç”¨åˆ°,è¿™æ˜¯å› ä¸ºï¼Œåœ¨è°ƒç”¨performSelector:onThread: withObject: waitUntilDoneçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªTimerçš„sourceï¼ŒåŠ åˆ°å¯¹åº”çš„RunLoopä¸Šå»ï¼Œç„¶è€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ²¡æœ‰RunLoop
    [self performSelector:@selector(backGroundThread1) onThread:[NSThread currentThread] withObject:nil waitUntilDone:NO];
    //é»˜è®¤æ˜¯ä¼šåœ¨MainRunLoopä¸­å»æ‰§è¡Œ,æ•…ä»–å¯ä»¥è°ƒç”¨åˆ°backGroundThread
    //    [self performSelector:@selector(backGroundThread1) withObject:nil];
}

- (void)tryPerformSelectorOnbackGroundThread2{
    //åœ¨tryPerformSelectorOnbackGroundThread1ä¸Šæˆ‘ä»¬æ·»åŠ ä¸ªRunLoop,æ­¤æ—¶backGroundThread2å°±å¯ä»¥è¢«è°ƒç”¨åˆ°
    [self performSelector:@selector(backGroundThread2) onThread:[NSThread currentThread] withObject:nil waitUntilDone:NO];
    [[NSRunLoop currentRunLoop] run];
}

- (void)mainThreadMethod{
    NSLog(@"execute %s",__func__);
}

- (void)backGroundThread1{
    NSLog(@"currentThread:%@",[NSThread currentThread]);
    NSLog(@"backGroundThread1 --> execute %s",__FUNCTION__);
}

- (void)backGroundThread2{
    NSLog(@"currentThread:%@",[NSThread currentThread]);
    NSLog(@"backGroundThread2 --> execute %s",__FUNCTION__);
}

```

æ‰§è¡Œç»“æœï¼š

```
2018-05-16 11:38:20.939516+0800 Test[6410:1215068] execute -[ViewController mainThreadMethod]
2018-05-16 11:38:20.940078+0800 Test[6410:1215134] currentThread:<NSThread: 0x600000470bc0>{number = 4, name = (null)}
2018-05-16 11:38:20.940309+0800 Test[6410:1215134] backGroundThread2 --> execute -[ViewController backGroundThread2]

```

****

****